<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <title>绑定管理</title>
    <style>
        /* 自定义表格行样式 */
        .data-table tr:hover {
            background-color: rgba(131, 192, 253, 0.1);
        }

        .bound-row {
            background-color: rgba(248, 175, 175, 0.2);
        }

        /* 选中行样式 */
        .selected-row {
            background-color: rgba(75, 82, 248, 0.15);
            border-left: 3px solid #4B52F8;
            font-weight: 500;
        }

        /* 加载动画样式 */
        .loading {
            display: none;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-left-color: #000;
            border-radius: 50%;
            width: 15px;
            height: 15px;
            animation: spin 1s linear infinite;
            margin-left: 5px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* 错误提示样式 */
        .error-message {
            color: red;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        /* 数据篮子样式 */
        .data-basket ul {
            list-style-type: none;
            padding: 0;
        }

        .data-basket li {
            background-color: #edf2f7;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .data-basket li .remove-btn {
            background-color: #e53e3e;
            color: white;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            text-align: center;
            line-height: 15px;
            cursor: pointer;
        }

        /* 已绑定比赛信息栏样式 */
        .bound-matches-info {
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 1rem;
            height: auto;
            min-height: 950px;
            overflow-y: auto;
            padding-right: 0.5rem; /* 防止滚动条遮挡内容 */
            max-height: calc(3*(16rem + 1rem)); /* 左侧3个卡片总高度（h-64=16rem，每个间距mt-4=1rem） */
        }

        /* 调整左侧数据卡片高度 */
        .h-64 { 
            height: 16rem !important; /* 确保左侧高度统一 */
        }

        /* 统一按钮样式 */
        .custom-btn {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 0.3rem 0.7rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .custom-btn:hover {
            background-color: #f3f4f6;
            border-color: #9ca3af;
        }

        .custom-btn:active {
            background-color: #e5e7eb;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        /* 新增样式：绑定条目容器 */
        .bound-item {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.25rem;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            background-color: white;
            min-height: 90px; /* 新增高度限制 */
            position: relative; /* 为删除按钮定位 */
            grid-template-columns: repeat(3, 1fr) 30px; /* 新增第四列用于按钮 */
        }

        .network-data div {
            font-size: 0.75rem; /* 原无设置，默认约0.875rem */
        }


/* 删除按钮新样式 */
.bound-item .delete-btn {
    background: #e53e3e;
    color: white;
    width: 24px;
    height: 100%; /* 高度充满容器 */
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: none;
    transition: background 0.2s;
    margin-left: auto; /* 右侧对齐 */
}

.bound-item .delete-btn:hover {
    background: #c53030;
}



        .network-data {
            padding: 0.5rem;
            border-radius: 0.25rem;
        }

        .network-data:nth-child(1) {
            border-left: 3px solid #4B52F8;
        }

        .network-data:nth-child(2) {
            border-left: 3px solid #2DD4BF;
        }

        .network-data:nth-child(3) {
            border-left: 3px solid #F59E0B;
        }

        .network-label {
            font-weight: 500;
            color: #6B7280;
            font-size: 0.875rem;
            display: block;
            margin-bottom: 0.25rem;
        }

        /* 选中状态样式优化 */
        .selected-row {
            background-color: rgba(75, 82, 248, 0.15);
            border-left: 3px solid #4B52F8;
            font-weight: 500;
            box-shadow: inset 0 0 4px rgba(75, 82, 248, 0.2);
        }

        /* 按钮状态样式 */
        #add-binding-btn {
            background-color: #4B52F8;
            color: white;
            border: none;
            font-weight: 600;
        }

        #add-binding-btn:disabled {
            background-color: #e5e7eb;
            color: #6B7280;
            cursor: not-allowed;
        }
        /* 新增提交按钮加载样式 */
.submit-loading {
    display: inline-block;
    margin-left: 8px;
}

/* 重复数据红色标记 */
.duplicate-text {
    color: #ef4444 !important;
    position: relative;
    font-weight: 500;
}

/* 鼠标悬停时显示提示 */
.duplicate-text:hover::after {
    content: "已存在重复记录";
    position: absolute;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 10;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
}

 

    
    </style>
</head>

<body class="bg-gray-100">
    <!-- 顶部导航栏 -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="index.html" class="text-xl font-bold text-blue-600">2VS2</a>
            <div class="flex space-x-4">
                <a href="index.html" class="text-gray-700 hover:text-blue-600">首页</a>
                <a href="binding.html" class="text-gray-700 hover:text-blue-600">赛事绑定</a>
                <a href="real_time_odds.html" class="text-gray-700 hover:text-blue-600">实时赔率</a>
                <a href="binding_record.html" class="text-gray-700 hover:text-blue-600">绑定记录</a>
                <a href="betting_record.html" class="text-gray-700 hover:text-blue-600">投注记录</a>
            </div>
            <div class="flex space-x-2">
                <a href="#" class="text-gray-700 hover:text-blue-600">登录</a>
                 
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <div class="container mx-auto px-4 py-6 grid grid-cols-12 gap-4">
        <!-- 左侧数据源区域（占8列） -->
        <div class="col-span-12 lg:col-span-6">
            <!-- 1网数据卡片 -->
            <div class="bg-white shadow-lg rounded-lg p-4">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">1网数据(GMT4)</h3>
                        <p class="text-xs text-gray-500" id="a-count">比赛数量：0</p>
                        <p class="error-message" id="a-error"></p>
                    </div>
                    <!-- 操作按钮区 -->
                    <div class="flex items-center space-x-2">
                        <!-- 搜索框 -->
                        <div class="relative">
                            <input type="text" data-source="a" placeholder="搜索联赛/球队/时间"
                                class="border border-gray-300 rounded-lg px-2 py-1 w-64 focus:outline-none focus:border-blue-600 text-xs">
                        </div>
                        <!-- 功能按钮 -->
                        <div class="flex items-center space-x-1">
                            <!-- 刷新按钮统一为 custom-btn 样式（保留原有灰色基调） -->
                            <button class="custom-btn text-xs" onclick="fetchData('http://103.67.52.236:6001/today_fixtures', 'a', this)">
                                刷新
                            </button>
                            <div class="loading" id="a-loading"></div>
                        </div>
                    </div>
                </div>
                <!-- 数据表格 -->
                <div class="h-64 overflow-y-auto">
                    <table class="w-full data-table text-xs" id="a-table">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="px-2 py-1 text-left">比赛时间</th>
                                <th class="px-2 py-1 text-left">联赛</th>
                                <th class="px-2 py-1 text-left">主队</th>
                                <th class="px-2 py-1 text-left">客队</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 2网数据卡片 -->
            <div class="bg-white shadow-lg rounded-lg p-4 mt-4">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">2网数据(GMT4)</h3>
                        <p class="text-xs text-gray-500" id="b-count">比赛数量：0</p>
                        <p class="error-message" id="b-error"></p>
                    </div>
                    <!-- 操作按钮区 -->
                    <div class="flex items-center space-x-2">
                        <!-- 搜索框 -->
                        <div class="relative">
                            <input type="text" data-source="b" placeholder="搜索联赛/球队/时间"
                                class="border border-gray-300 rounded-lg px-2 py-1 w-64 focus:outline-none focus:border-blue-600 text-xs">
                        </div>
                        <!-- 功能按钮 -->
                        <div class="flex items-center space-x-1">
                            <button class="custom-btn text-xs" onclick="fetchData('http://103.67.52.236:6002/matches', 'b', this)">
                                刷新
                            </button>
                            <div class="loading" id="b-loading"></div>
                        </div>
                    </div>
                </div>
                <!-- 数据表格 -->
                <div class="h-64 overflow-y-auto">
                    <table class="w-full data-table text-xs" id="b-table">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="px-2 py-1 text-left">比赛时间</th>
                                <th class="px-2 py-1 text-left">联赛</th>
                                <th class="px-2 py-1 text-left">主队</th>
                                <th class="px-2 py-1 text-left">客队</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 3网数据卡片 -->
            <div class="bg-white shadow-lg rounded-lg p-4 mt-4">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">3网数据(GMT4)</h3>
                        <p class="text-xs text-gray-500" id="c-count">比赛数量：0</p>
                        <p class="error-message" id="c-error"></p>
                    </div>
                    <!-- 操作按钮区 -->
                    <div class="flex items-center space-x-2">
                        <!-- 搜索框 -->
                        <div class="relative">
                            <input type="text" data-source="c" placeholder="搜索联赛/球队/时间"
                                class="border border-gray-300 rounded-lg px-2 py-1 w-64 focus:outline-none focus:border-blue-600 text-xs">
                        </div>
                        <!-- 功能按钮 -->
                        <div class="flex items-center space-x-1">
                            <button class="custom-btn text-xs" onclick="fetchData('http://103.67.52.236:6003/get_soccer_events', 'c', this)">
                                刷新
                            </button>
                            <div class="loading" id="c-loading"></div>
                        </div>
                    </div>
                </div>
                <!-- 数据表格 -->
                <div class="h-64 overflow-y-auto">
                    <table class="w-full data-table text-xs" id="c-table">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="px-2 py-1 text-left">比赛时间</th>
                                <th class="px-2 py-1 text-left">联赛</th>
                                <th class="px-2 py-1 text-left">主队</th>
                                <th class="px-2 py-1 text-left">客队</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 右侧新区域 -->
        <div class="col-span-12 lg:col-span-6">
            <div class="bg-white shadow-lg rounded-lg p-4">
                <h4 class="text-base font-bold text-gray-800 mb-4">已绑定比赛管理</h4>
                <div class="flex flex-wrap justify-end -mx-2 mb-4">
                    <!-- 所有右侧按钮统一为 custom-btn 样式，移除原 Tailwind 颜色类 -->
                    <button id="add-binding-btn" class="custom-btn m-2 disabled" disabled>
                        添加绑定 <i class="fas fa-plus ml-1"></i>
                    </button>
                    <button class="custom-btn m-2" id="quick-bind-btn">快速绑定</button>
                    <!-- 修改后 -->
<button class="custom-btn m-2" style="color: green;" id="submit-btn">
    提交
    <span class="submit-loading" style="display: none;">
        <i class="fas fa-spinner fa-spin ml-1"></i>
    </span>
</button>
                    <button class="custom-btn m-2" style="color: #e53e3e;">清空</button>
                </div>
                <div class="bound-matches-info" id="bound-matches-container">
                    <!-- 这里后续可添加比赛信息 -->
                </div>
            </div>
        </div>
    </div>
    <!-- 底部信息 -->
    <footer class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4 text-center text-gray-600">
            <p>&copy; 版本:27/04/2025</p>
             
        </div>
    </footer>

    <!-- 底部预留的JavaScript逻辑 -->
    <script>

        
        // 必须最先定义的绑定管理器
    const bindingManager = {
        usedMatches: new Set(),
        
        isBound(source, match) {
            return this.usedMatches.has(`${source}-${match.league}-${match.home_team}-${match.away_team}`);
        },
        
        addBinding(source, match) {
            this.usedMatches.add(`${source}-${match.league}-${match.home_team}-${match.away_team}`);
        },
        
        removeBinding(source, match) {
            this.usedMatches.delete(`${source}-${match.league}-${match.home_team}-${match.away_team}`);
        },
        
        clear() {
            this.usedMatches.clear();
        }
    };

    // 原数据结构和初始化
    const selectedFixtures = { a: null, b: null, c: null };
    const dataSources = {
        a: { tableId: 'a-table', source: 'a', color: '#4B52F8' },
        b: { tableId: 'b-table', source: 'b', color: '#2DD4BF' },
        c: { tableId: 'c-table', source: 'c', color: '#F59E0B' },
    };
    let dataSourcesData = {
        a: { fixtures: [], table: null, searchInput: null },
        b: { fixtures: [], table: null, searchInput: null },
        c: { fixtures: [], table: null, searchInput: null }
    };

    // 强化清空功能
document.querySelector('button.custom-btn[style*="color: #e53e3e;"]').addEventListener('click', () => {
    document.getElementById('bound-matches-container').innerHTML = '';
    bindingManager.clear();
    ['a', 'b', 'c'].forEach(source => {
        dataSourcesData[source].fixtures.forEach(match => {
            match.isBound = false;
        });
        const table = dataSourcesData[source].table;
        if (table) updateTable(source);
    });
});
        
        // 选中行处理函数（优化版）
        function selectRow(row, source) {
            // 清除当前数据源之前的选中
            const prevSelected = document.querySelector(`#${dataSources[source].tableId} tr.selected-row`);
            if (prevSelected) prevSelected.classList.remove('selected-row');

            row.classList.add('selected-row');
            const index = row.dataset.fixtureIndex;
            selectedFixtures[source] = dataSourcesData[source].fixtures[index]; // 存储选中数据

            // 检查是否三网都已选中
            const allSelected = Object.values(selectedFixtures).every(f => f);
            document.getElementById('add-binding-btn').disabled = !allSelected;
        }

        // 通用搜索过滤函数
        function filterFixtures(source, keyword) {
            const { fixtures, table } = dataSourcesData[source];
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = tbody.querySelectorAll('tr');

            keyword = keyword.trim().toLowerCase();
            rows.forEach((row, index) => {
                const fixture = fixtures[index]; // 假设数据顺序与表格行一致
                if (!fixture) return; // 防止数据错位

                // 提取关键信息（时间、联赛、主客队）
                const time = fixture.time.toLowerCase();
                const league = fixture.league.toLowerCase();
                const home = fixture.home_team.toLowerCase();
                const away = fixture.away_team.toLowerCase();

                // 检查是否包含关键词（支持多关键词，空格分隔为"与"关系）
                const match = keyword.split(' ').every(word => {
                    return time.includes(word) ||
                        league.includes(word) ||
                        home.includes(word) ||
                        away.includes(word);
                });

                row.style.display = match ? '' : 'none'; // 显示/隐藏行
            });
        }

        // 防抖函数
        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

    // 从接口获取数据并填充表格（完整修复版）
async function fetchData(url, source, button) {
    const loading = document.getElementById(`${source}-loading`);
    const errorElement = document.getElementById(`${source}-error`);
    loading.style.display = 'block';
    button.disabled = true;
    errorElement.textContent = '';

    try {
        // 步骤1：获取原始数据
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`网络响应错误: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();
        console.log(`获取到的 ${source} 网数据:`, data);

        // 步骤2：验证数据结构
        if (typeof data.count === 'undefined' || typeof data.fixtures === 'undefined') {
            throw new Error('响应数据格式错误');
        }

        // 步骤3：发送重复检查请求
        const sourceNumber = source === 'a' ? 1 : source === 'b' ? 2 : 3;
        const checkResponse = await fetch('http://160.25.20.123:8080/api/bindings/check-duplicates', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                source: sourceNumber,
                matches: data.fixtures.map(f => ({
                    league: f.league,
                    homeTeam: f.home_team,
                    awayTeam: f.away_team
                }))
            })
        });

        if (!checkResponse.ok) {
            throw new Error('重复检查请求失败');
        }

        // 步骤4：处理重复数据（修复关键点）
        const duplicates = await checkResponse.json();
        
        // 转换数组为Set
        const leaguesSet = new Set(duplicates.leagues || []);
        const teamsSet = new Set(duplicates.teams || []);

        // 过滤逻辑
        const filteredFixtures = data.fixtures.filter(fixture => {
            const isLeagueExist = leaguesSet.has(fixture.league);
            const isHomeExist = teamsSet.has(fixture.home_team);
            const isAwayExist = teamsSet.has(fixture.away_team);
            return !(isLeagueExist && isHomeExist && isAwayExist);
        });

        // 步骤5：更新DOM元素引用
        const table = document.getElementById(`${source}-table`);
        const tbody = table.getElementsByTagName('tbody')[0];
        const countElement = document.getElementById(`${source}-count`);
        const searchInput = document.querySelector(`[data-source="${source}"] input`);

        // 步骤6：清空并重新填充表格
        tbody.innerHTML = '';
        filteredFixtures.forEach((fixture, index) => {
            if (!fixture.time || !fixture.league || !fixture.home_team || !fixture.away_team) {
                console.warn('无效的比赛数据:', fixture);
                return;
            }

            const row = tbody.insertRow();
            row.dataset.fixtureIndex = index;

            // 创建带重复标记的单元格（使用转换后的Set）
            const createCell = (value, isDuplicate) => {
                const cell = row.insertCell();
                cell.textContent = value;
                if (isDuplicate) cell.classList.add('duplicate-text');
            };

            // 填充数据
            createCell(fixture.time, false);
            createCell(fixture.league, leaguesSet.has(fixture.league));
            createCell(fixture.home_team, teamsSet.has(fixture.home_team));
            createCell(fixture.away_team, teamsSet.has(fixture.away_team));

            // 保留点击事件
            row.onclick = () => selectRow(row, source);
        });

        // 步骤7：更新数据存储
        dataSourcesData[source] = {
            fixtures: filteredFixtures,
            table: table,
            searchInput: searchInput
        };

        // 更新计数器
        countElement.textContent = `比赛数量：${filteredFixtures.length}`;

    } catch (error) {
        console.error(`操作失败: ${error.message}`);
        errorElement.textContent = `错误: ${error.message.replace(/^Error: /, '')}`;
    } finally {
        loading.style.display = 'none';
        button.disabled = false;
    }
}


        // 添加绑定按钮点击事件
        document.getElementById('add-binding-btn').addEventListener('click', () => {
            const boundItem = document.createElement('div');
            boundItem.className = 'bound-item';

            // 生成三个网络的显示块
            ['a', 'b', 'c'].forEach(source => {
                const fixture = selectedFixtures[source];
                const networkDiv = document.createElement('div');
                networkDiv.className = `network-data bg-${source === 'a' ? 'blue' : source === 'b' ? 'green' : 'orange'}-50`;

                networkDiv.innerHTML = `
                    <div class="network-label">${
                        source === 'a' ? '1' : 
                        source === 'b' ? '2' : '3'
                        }网数据</div>
                    <div>联赛：${fixture.league}</div>
                    <div>主队：${fixture.home_team}</div>
                    <div>客队：${fixture.away_team}</div>
                    <div>时间：${fixture.time}</div>
                `;

                boundItem.appendChild(networkDiv);
            });

            // 添加删除功能
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn'; // 使用新定义的样式类
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteBtn.onclick = () => boundItem.remove();
            boundItem.appendChild(deleteBtn);

            document.getElementById('bound-matches-container').prepend(boundItem);

            // 清除选中状态
            Object.keys(selectedFixtures).forEach(source => {
                selectedFixtures[source] = null;
                const table = dataSourcesData[source].table;
                table.querySelectorAll('tr').forEach(tr => tr.classList.remove('selected-row'));
            });
            document.getElementById('add-binding-btn').disabled = true;
        });

        // 初始化搜索框监听
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input[data-source]').forEach(input => {
                const source = input.dataset.source;
                input.addEventListener('input', debounce((e) => {
                    filterFixtures(source, e.target.value);
                }, 300)); // 300ms防抖延迟
            });
        });



       // 修复后的updateTable函数
function updateTable(source) {
    const { fixtures, table, searchInput } = dataSourcesData[source];
    const tbody = table.getElementsByTagName('tbody')[0];
    tbody.innerHTML = '';

    // 重新填充表格行（保持原有逻辑）
    fixtures.forEach((fixture, index) => {
        const row = tbody.insertRow();
        row.dataset.fixtureIndex = index;

        // 创建带重复标记的单元格
        const createCell = (value, isDuplicate) => {
            const cell = row.insertCell();
            cell.textContent = value;
            if (isDuplicate) cell.classList.add('duplicate-text');
        };

        createCell(fixture.time, false);
        createCell(fixture.league, false);
        createCell(fixture.home_team, false);
        createCell(fixture.away_team, false);

        row.onclick = () => selectRow(row, source);
    });

    // 更新计数器
    const countElement = document.getElementById(`${source}-count`);
    countElement.textContent = `比赛数量：${fixtures.length}`;

    // 安全处理searchInput可能为null的情况
    const keyword = searchInput ? searchInput.value.trim().toLowerCase() : '';
    filterFixtures(source, keyword);
}






// 修改提交按钮点击事件处理函数
document.querySelector('button.custom-btn[style="color: green;"]').addEventListener('click', async () => {
    const submitBtn = document.getElementById('submit-btn');
    const loadingSpan = submitBtn.querySelector('.submit-loading');
    loadingSpan.style.display = 'inline-block';
    submitBtn.disabled = true;

    try {
        // 获取当前所有绑定条目
        const boundItems = document.querySelectorAll('.bound-item');
        const requests = [];

        // 准备提交数据
        boundItems.forEach(item => {
            const request = { 
                source1: parseSourceData(item, 0),
                source2: parseSourceData(item, 1),
                source3: parseSourceData(item, 2)
            };
            requests.push(request);
        });

        // 发送提交请求
        const response = await fetch('http://160.25.20.123:8080/api/bindings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requests),
        });

        if (!response.ok) {
            throw new Error(`提交失败: ${response.statusText}`);
        }

        alert('提交成功！');
        document.getElementById('bound-matches-container').innerHTML = '';

        // 新增：安全移除数据
        boundItems.forEach(item => {
            const sourcesData = [0,1,2].map(i => parseSourceData(item, i))
                              .filter(data => data !== null);

            sourcesData.forEach(data => {
                const sourceKey = ['a', 'b', 'c'][data.source - 1];
                const fixturesArray = dataSourcesData[sourceKey]?.fixtures;
                
                if (!fixturesArray) return;

                const indexToRemove = fixturesArray.findIndex(f => 
                    f.league === data.leagueName &&
                    f.home_team === data.homeTeam &&
                    f.away_team === data.awayTeam &&
                    f.time === data.matchTime
                );

                if (indexToRemove !== -1) {
                    fixturesArray.splice(indexToRemove, 1);
                    updateTable(sourceKey);
                }
            });
        });

    } catch (error) {
        console.error('提交错误:', error);
        alert(`提交失败: ${error.message}`);
    } finally {
        loadingSpan.style.display = 'none';
        submitBtn.disabled = false;
    }
});


  
 

// 新增单词分割函数
const splitWords = (str) => {
    return str.toLowerCase()
        .split(/[^\w\u4e00-\u9fa5]+/) // 分割单词（保留中文和字母数字）
        .filter(word => word.length > 1); // 过滤单字符
};

// 完整快速绑定函数
async function quickBind() {
    const $btn = document.getElementById('quick-bind-btn');
    if (!$btn) return;

    try {
        // 禁用按钮并显示加载状态
        $btn.disabled = true;
        $btn.innerHTML = '处理中 <i class="fas fa-spinner fa-spin"></i>';

        // 准备数据：为每个比赛创建单词索引
        const prepareMatches = (source) => {
            return dataSourcesData[source].fixtures
                .filter(f => !bindingManager.isBound(source, f)) // 过滤已绑定
                .map(match => ({
                    raw: match, // 保留原始数据引用
                    source: source,
                    time: match.time,
                    leagueWords: new Set(splitWords(match.league)),
                    homeWords: new Set(splitWords(match.home_team)),
                    awayWords: new Set(splitWords(match.away_team))
                }));
        };

        // 获取三个数据源的预处理数据
        const aMatches = prepareMatches('a');
        const bMatches = prepareMatches('b');
        const cMatches = prepareMatches('c');

        const validCombinations = [];

        // 主匹配逻辑（三重循环）
        for (const aMatch of aMatches) {
            for (const bMatch of bMatches) {
                // 第一阶段：AB匹配检查
                // 1. 时间必须一致
                if (aMatch.time !== bMatch.time) continue;
                
                // 2. 联赛字段至少一个共同词
                const hasLeagueMatchAB = [...aMatch.leagueWords].some(w => bMatch.leagueWords.has(w));
                // 3. 主队字段至少一个共同词
                const hasHomeMatchAB = [...aMatch.homeWords].some(w => bMatch.homeWords.has(w));
                // 4. 客队字段至少一个共同词
                const hasAwayMatchAB = [...aMatch.awayWords].some(w => bMatch.awayWords.has(w));
                
                if (!hasLeagueMatchAB || !hasHomeMatchAB || !hasAwayMatchAB) continue;

                // 第二阶段：寻找匹配的C网数据
                for (const cMatch of cMatches) {
                    // 1. 时间必须三方一致
                    if (aMatch.time !== cMatch.time) continue;

                    // 2. 检查AC匹配
                    const hasLeagueMatchAC = [...aMatch.leagueWords].some(w => cMatch.leagueWords.has(w));
                    const hasHomeMatchAC = [...aMatch.homeWords].some(w => cMatch.homeWords.has(w));
                    const hasAwayMatchAC = [...aMatch.awayWords].some(w => cMatch.awayWords.has(w));
                    const isACValid = hasLeagueMatchAC && hasHomeMatchAC && hasAwayMatchAC;

                    // 3. 检查BC匹配
                    const hasLeagueMatchBC = [...bMatch.leagueWords].some(w => cMatch.leagueWords.has(w));
                    const hasHomeMatchBC = [...bMatch.homeWords].some(w => cMatch.homeWords.has(w));
                    const hasAwayMatchBC = [...bMatch.awayWords].some(w => cMatch.awayWords.has(w));
                    const isBCValid = hasLeagueMatchBC && hasHomeMatchBC && hasAwayMatchBC;

                    // 最终匹配条件：AC或BC完全匹配
                    if (isACValid || isBCValid) {
                        // 检查是否已绑定
                        const isUsed = [aMatch, bMatch, cMatch].some(m => 
                            bindingManager.isBound(m.source, m.raw)
                        );
                        if (isUsed) continue;

                        // 记录有效组合
                        validCombinations.push({
                            a: aMatch.raw,
                            b: bMatch.raw,
                            c: cMatch.raw
                        });

                        // 标记为已绑定
                        bindingManager.addBinding('a', aMatch.raw);
                        bindingManager.addBinding('b', bMatch.raw);
                        bindingManager.addBinding('c', cMatch.raw);
                    }
                }
            }
        }

        // 添加绑定条目到界面
        if (validCombinations.length > 0) {
            validCombinations.forEach(combo => {
                const boundItem = document.createElement('div');
                boundItem.className = 'bound-item';

                // 添加三个数据源显示
                [combo.a, combo.b, combo.c].forEach((match, index) => {
                    const source = ['a', 'b', 'c'][index];
                    const div = document.createElement('div');
                    div.className = `network-data bg-${{
                        a: 'blue', b: 'green', c: 'orange'
                    }[source]}-50 p-2 rounded`;
                    
                    div.innerHTML = `
                        <div class="network-label font-bold">${index+1}网数据</div>
                        <div class="text-sm">联赛：${match.league}</div>
                        <div class="text-sm">主队：${match.home_team}</div>
                        <div class="text-sm">客队：${match.away_team}</div>
                        <div class="text-xs text-gray-500">时间：${match.time}</div>
                    `;
                    
                    boundItem.appendChild(div);
                });

                // 添加删除按钮
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn hover:bg-red-700 transition-colors';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.onclick = () => {
                    // 解除绑定状态
                    bindingManager.removeBinding('a', combo.a);
                    bindingManager.removeBinding('b', combo.b);
                    bindingManager.removeBinding('c', combo.c);
                    
                    // 更新原始数据状态
                    ['a', 'b', 'c'].forEach(source => {
                        const match = combo[source];
                        const original = dataSourcesData[source].fixtures.find(f => 
                            f.league === match.league &&
                            f.home_team === match.home_team &&
                            f.away_team === match.away_team
                        );
                        if (original) original.isBound = false;
                        updateTable(source);
                    });

                    boundItem.remove();
                };
                
                boundItem.appendChild(deleteBtn);
                document.getElementById('bound-matches-container').appendChild(boundItem);
            });

            alert(`成功添加 ${validCombinations.length} 组绑定！`);
        } else {
            alert('⚠️ 未找到符合要求的匹配组合');
        }

    } catch (error) {
        console.error('快速绑定失败:', error);
        alert(`操作失败：${error.message}`);
    } finally {
        // 恢复按钮状态
        $btn.disabled = false;
        $btn.innerHTML = '快速绑定';
    }
}

// 初始化代码（必须放在DOM加载后！）
document.addEventListener('DOMContentLoaded', () => {
    // 确保按钮存在
    const quickBindBtn = document.getElementById('quick-bind-btn');
    if (!quickBindBtn) {
        console.error('快速绑定按钮未找到，请检查HTML中的按钮ID');
        return;
    }

    // 绑定事件
    quickBindBtn.addEventListener('click', quickBind);
    
    // 初始化数据源引用
    dataSourcesData = {
        a: { fixtures: [], table: document.getElementById('a-table') },
        b: { fixtures: [], table: document.getElementById('b-table') },
        c: { fixtures: [], table: document.getElementById('c-table') }
    };
});

// 增强型parseSourceData函数
function parseSourceData(item, index) {
    try {
        const sourceDivs = item.querySelectorAll('.network-data');
        if (index >= sourceDivs.length) return null;
        
        const sourceDiv = sourceDivs[index];
        const children = sourceDiv.children;
        if (children.length < 5) return null;

        return {
            leagueName: children[1].textContent.split('：')[1].trim(),
            homeTeam: children[2].textContent.split('：')[1].trim(),
            awayTeam: children[3].textContent.split('：')[1].trim(),
            matchTime: children[4].textContent.split('：')[1].trim(),
            source: index + 1
        };
    } catch (error) {
        console.error('解析数据失败:', error);
        return null;
    }
}
 
    </script>
</body>

</html>