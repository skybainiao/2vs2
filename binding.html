<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <title>绑定管理</title>
    <style>
        /* 自定义表格行样式 */
        .data-table tr:hover {
            background-color: rgba(131, 192, 253, 0.1);
        }

        .bound-row {
            background-color: rgba(248, 175, 175, 0.2);
        }

        /* 选中行样式 */
        .selected-row {
            background-color: rgba(75, 82, 248, 0.15);
            border-left: 3px solid #4B52F8;
            font-weight: 500;
        }

        /* 加载动画样式 */
        .loading {
            display: none;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-left-color: #000;
            border-radius: 50%;
            width: 15px;
            height: 15px;
            animation: spin 1s linear infinite;
            margin-left: 5px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* 错误提示样式 */
        .error-message {
            color: red;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        /* 数据篮子样式 */
        .data-basket ul {
            list-style-type: none;
            padding: 0;
        }

        .data-basket li {
            background-color: #edf2f7;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .data-basket li .remove-btn {
            background-color: #e53e3e;
            color: white;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            text-align: center;
            line-height: 15px;
            cursor: pointer;
        }

        /* 已绑定比赛信息栏样式 */
        .bound-matches-info {
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 1rem;
            height: auto;
            min-height: 600px;
            overflow-y: auto;
            padding-right: 0.5rem; /* 防止滚动条遮挡内容 */
            max-height: calc(3*(16rem + 1rem)); /* 左侧3个卡片总高度（h-64=16rem，每个间距mt-4=1rem） */
        }

        /* 调整左侧数据卡片高度 */
        .h-64 { 
            height: 16rem !important; /* 确保左侧高度统一 */
        }

        /* 统一按钮样式 */
        .custom-btn {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 0.3rem 0.7rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .custom-btn:hover {
            background-color: #f3f4f6;
            border-color: #9ca3af;
        }

        .custom-btn:active {
            background-color: #e5e7eb;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        /* 新增样式：绑定条目容器 */
        .bound-item {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.25rem;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            background-color: white;
            min-height: 90px; /* 新增高度限制 */
            position: relative; /* 为删除按钮定位 */
            grid-template-columns: repeat(3, 1fr) 30px; /* 新增第四列用于按钮 */
        }

        .network-data div {
            font-size: 0.75rem; /* 原无设置，默认约0.875rem */
        }


/* 删除按钮新样式 */
.bound-item .delete-btn {
    background: #e53e3e;
    color: white;
    width: 24px;
    height: 100%; /* 高度充满容器 */
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: none;
    transition: background 0.2s;
    margin-left: auto; /* 右侧对齐 */
}

.bound-item .delete-btn:hover {
    background: #c53030;
}



        .network-data {
            padding: 0.5rem;
            border-radius: 0.25rem;
        }

        .network-data:nth-child(1) {
            border-left: 3px solid #4B52F8;
        }

        .network-data:nth-child(2) {
            border-left: 3px solid #2DD4BF;
        }

        .network-data:nth-child(3) {
            border-left: 3px solid #F59E0B;
        }

        .network-label {
            font-weight: 500;
            color: #6B7280;
            font-size: 0.875rem;
            display: block;
            margin-bottom: 0.25rem;
        }

        /* 选中状态样式优化 */
        .selected-row {
            background-color: rgba(75, 82, 248, 0.15);
            border-left: 3px solid #4B52F8;
            font-weight: 500;
            box-shadow: inset 0 0 4px rgba(75, 82, 248, 0.2);
        }

        /* 按钮状态样式 */
        #add-binding-btn {
            background-color: #4B52F8;
            color: white;
            border: none;
            font-weight: 600;
        }

        #add-binding-btn:disabled {
            background-color: #e5e7eb;
            color: #6B7280;
            cursor: not-allowed;
        }
    </style>
</head>

<body class="bg-gray-100">
    <!-- 顶部导航栏 -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="index.html" class="text-xl font-bold text-blue-600">2VS2</a>
            <div class="flex space-x-4">
                <a href="index.html" class="text-gray-700 hover:text-blue-600">首页</a>
                <a href="binding.html" class="text-gray-700 hover:text-blue-600">赛事绑定</a>
                <a href="real_time_odds.html" class="text-gray-700 hover:text-blue-600">实时赔率</a>
                <a href="binding_record.html" class="text-gray-700 hover:text-blue-600">绑定记录</a>
                <a href="betting_record.html" class="text-gray-700 hover:text-blue-600">投注记录</a>
            </div>
            <div class="flex space-x-2">
                <a href="#" class="text-gray-700 hover:text-blue-600">登录</a>
                <a href="#" class="text-gray-700 hover:text-blue-600">注册</a>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <div class="container mx-auto px-4 py-6 grid grid-cols-12 gap-4">
        <!-- 左侧数据源区域（占8列） -->
        <div class="col-span-12 lg:col-span-6">
            <!-- 1网数据卡片 -->
            <div class="bg-white shadow-lg rounded-lg p-4">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">1网数据</h3>
                        <p class="text-xs text-gray-500" id="a-count">比赛数量：0</p>
                        <p class="error-message" id="a-error"></p>
                    </div>
                    <!-- 操作按钮区 -->
                    <div class="flex items-center space-x-2">
                        <!-- 搜索框 -->
                        <div class="relative">
                            <input type="text" data-source="a" placeholder="搜索联赛/球队/时间"
                                class="border border-gray-300 rounded-lg px-2 py-1 w-64 focus:outline-none focus:border-blue-600 text-xs">
                        </div>
                        <!-- 功能按钮 -->
                        <div class="flex items-center space-x-1">
                            <!-- 刷新按钮统一为 custom-btn 样式（保留原有灰色基调） -->
                            <button class="custom-btn text-xs" onclick="fetchData('http://localhost:6001/today_fixtures', 'a', this)">
                                刷新
                            </button>
                            <div class="loading" id="a-loading"></div>
                        </div>
                    </div>
                </div>
                <!-- 数据表格 -->
                <div class="h-64 overflow-y-auto">
                    <table class="w-full data-table text-xs" id="a-table">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="px-2 py-1 text-left">比赛时间</th>
                                <th class="px-2 py-1 text-left">联赛</th>
                                <th class="px-2 py-1 text-left">主队</th>
                                <th class="px-2 py-1 text-left">客队</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 2网数据卡片 -->
            <div class="bg-white shadow-lg rounded-lg p-4 mt-4">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">2网数据</h3>
                        <p class="text-xs text-gray-500" id="b-count">比赛数量：0</p>
                        <p class="error-message" id="b-error"></p>
                    </div>
                    <!-- 操作按钮区 -->
                    <div class="flex items-center space-x-2">
                        <!-- 搜索框 -->
                        <div class="relative">
                            <input type="text" data-source="b" placeholder="搜索联赛/球队/时间"
                                class="border border-gray-300 rounded-lg px-2 py-1 w-64 focus:outline-none focus:border-blue-600 text-xs">
                        </div>
                        <!-- 功能按钮 -->
                        <div class="flex items-center space-x-1">
                            <button class="custom-btn text-xs" onclick="fetchData('http://localhost:6002/matches', 'b', this)">
                                刷新
                            </button>
                            <div class="loading" id="b-loading"></div>
                        </div>
                    </div>
                </div>
                <!-- 数据表格 -->
                <div class="h-64 overflow-y-auto">
                    <table class="w-full data-table text-xs" id="b-table">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="px-2 py-1 text-left">比赛时间</th>
                                <th class="px-2 py-1 text-left">联赛</th>
                                <th class="px-2 py-1 text-left">主队</th>
                                <th class="px-2 py-1 text-left">客队</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 3网数据卡片 -->
            <div class="bg-white shadow-lg rounded-lg p-4 mt-4">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">3网数据</h3>
                        <p class="text-xs text-gray-500" id="c-count">比赛数量：0</p>
                        <p class="error-message" id="c-error"></p>
                    </div>
                    <!-- 操作按钮区 -->
                    <div class="flex items-center space-x-2">
                        <!-- 搜索框 -->
                        <div class="relative">
                            <input type="text" data-source="c" placeholder="搜索联赛/球队/时间"
                                class="border border-gray-300 rounded-lg px-2 py-1 w-64 focus:outline-none focus:border-blue-600 text-xs">
                        </div>
                        <!-- 功能按钮 -->
                        <div class="flex items-center space-x-1">
                            <button class="custom-btn text-xs" onclick="fetchData('http://localhost:6003/get_soccer_events', 'c', this)">
                                刷新
                            </button>
                            <div class="loading" id="c-loading"></div>
                        </div>
                    </div>
                </div>
                <!-- 数据表格 -->
                <div class="h-64 overflow-y-auto">
                    <table class="w-full data-table text-xs" id="c-table">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="px-2 py-1 text-left">比赛时间</th>
                                <th class="px-2 py-1 text-left">联赛</th>
                                <th class="px-2 py-1 text-left">主队</th>
                                <th class="px-2 py-1 text-left">客队</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 右侧新区域 -->
        <div class="col-span-12 lg:col-span-6">
            <div class="bg-white shadow-lg rounded-lg p-4">
                <h4 class="text-base font-bold text-gray-800 mb-4">已绑定比赛管理</h4>
                <div class="flex flex-wrap justify-end -mx-2 mb-4">
                    <!-- 所有右侧按钮统一为 custom-btn 样式，移除原 Tailwind 颜色类 -->
                    <button id="add-binding-btn" class="custom-btn m-2 disabled" disabled>
                        添加绑定 <i class="fas fa-plus ml-1"></i>
                    </button>
                    <button class="custom-btn m-2">模糊绑定</button>
                    <button class="custom-btn m-2" style="color: green;">提交</button>
                    <button class="custom-btn m-2" style="color: #e53e3e;">清空</button>
                </div>
                <div class="bound-matches-info" id="bound-matches-container">
                    <!-- 这里后续可添加比赛信息 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 底部预留的JavaScript逻辑 -->
    <script>
        // 新增：存储各数据源选中的比赛
        const selectedFixtures = { a: null, b: null, c: null };

        // 初始化数据源配置
        const dataSources = {
            a: { tableId: 'a-table', source: 'a', color: '#4B52F8' },
            b: { tableId: 'b-table', source: 'b', color: '#2DD4BF' },
            c: { tableId: 'c-table', source: 'c', color: '#F59E0B' },
        };

        // 存储各数据源的原始数据和DOM引用
        const dataSourcesData = {
            a: { fixtures: [], table: null, searchInput: null },
            b: { fixtures: [], table: null, searchInput: null },
            c: { fixtures: [], table: null, searchInput: null }
        };

        // 找到清空按钮并添加点击事件
        document.querySelector('button.custom-btn[style*="color: #e53e3e;"]').addEventListener('click', () => {
            document.getElementById('bound-matches-container').innerHTML = '';
        });
        
        // 选中行处理函数（优化版）
        function selectRow(row, source) {
            // 清除当前数据源之前的选中
            const prevSelected = document.querySelector(`#${dataSources[source].tableId} tr.selected-row`);
            if (prevSelected) prevSelected.classList.remove('selected-row');

            row.classList.add('selected-row');
            const index = row.dataset.fixtureIndex;
            selectedFixtures[source] = dataSourcesData[source].fixtures[index]; // 存储选中数据

            // 检查是否三网都已选中
            const allSelected = Object.values(selectedFixtures).every(f => f);
            document.getElementById('add-binding-btn').disabled = !allSelected;
        }

        // 通用搜索过滤函数
        function filterFixtures(source, keyword) {
            const { fixtures, table } = dataSourcesData[source];
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = tbody.querySelectorAll('tr');

            keyword = keyword.trim().toLowerCase();
            rows.forEach((row, index) => {
                const fixture = fixtures[index]; // 假设数据顺序与表格行一致
                if (!fixture) return; // 防止数据错位

                // 提取关键信息（时间、联赛、主客队）
                const time = fixture.time.toLowerCase();
                const league = fixture.league.toLowerCase();
                const home = fixture.home_team.toLowerCase();
                const away = fixture.away_team.toLowerCase();

                // 检查是否包含关键词（支持多关键词，空格分隔为"与"关系）
                const match = keyword.split(' ').every(word => {
                    return time.includes(word) ||
                        league.includes(word) ||
                        home.includes(word) ||
                        away.includes(word);
                });

                row.style.display = match ? '' : 'none'; // 显示/隐藏行
            });
        }

        // 防抖函数
        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // 从接口获取数据并填充表格
        async function fetchData(url, source, button) {
            const loading = document.getElementById(`${source}-loading`);
            const errorElement = document.getElementById(`${source}-error`);
            loading.style.display = 'block';
            button.disabled = true;
            errorElement.textContent = '';

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`网络响应错误: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                console.log(`获取到的 ${source} 网数据:`, data);

                const table = document.getElementById(`${source}-table`);
                const tbody = table.getElementsByTagName('tbody')[0];
                const countElement = document.getElementById(`${source}-count`);
                const searchInput = document.querySelector(`[data-source="${source}"] input`); // 获取搜索框

                if (typeof data.count === 'undefined') {
                    throw new Error('响应数据中缺少 count 字段');
                }
                if (typeof data.fixtures === 'undefined') {
                    throw new Error('响应数据中缺少 fixtures 字段');
                }

                // 存储数据和DOM引用
                dataSourcesData[source].fixtures = data.fixtures;
                dataSourcesData[source].table = table;
                dataSourcesData[source].searchInput = searchInput;

                countElement.textContent = `比赛数量：${data.count}`;
                // 清空表格
                tbody.innerHTML = '';

                data.fixtures.forEach((fixture, index) => {
                    if (!fixture.time || !fixture.league || !fixture.home_team || !fixture.away_team) {
                        console.warn('比赛数据缺少必要字段:', fixture);
                        return;
                    }
                    const row = tbody.insertRow();
                    const timeCell = row.insertCell(0);
                    const leagueCell = row.insertCell(1);
                    const homeTeamCell = row.insertCell(2);
                    const awayTeamCell = row.insertCell(3);
                    timeCell.textContent = fixture.time;
                    leagueCell.textContent = fixture.league;
                    homeTeamCell.textContent = fixture.home_team;
                    awayTeamCell.textContent = fixture.away_team;
                    row.dataset.fixtureIndex = index; // 存储数据索引
                    row.onclick = () => selectRow(row, source);
                });
            } catch (error) {
                console.error(`获取数据时出错: ${error.message}`);
                errorElement.textContent = `获取数据时出错: ${error.message}`;
            } finally {
                loading.style.display = 'none';
                button.disabled = false;
            }
        }

        // 添加绑定按钮点击事件
        document.getElementById('add-binding-btn').addEventListener('click', () => {
            const boundItem = document.createElement('div');
            boundItem.className = 'bound-item';

            // 生成三个网络的显示块
            ['a', 'b', 'c'].forEach(source => {
                const fixture = selectedFixtures[source];
                const networkDiv = document.createElement('div');
                networkDiv.className = `network-data bg-${source === 'a' ? 'blue' : source === 'b' ? 'green' : 'orange'}-50`;

                networkDiv.innerHTML = `
                    <div class="network-label">${
                        source === 'a' ? '1' : 
                        source === 'b' ? '2' : '3'
                        }网数据</div>
                    <div>联赛：${fixture.league}</div>
                    <div>主队：${fixture.home_team}</div>
                    <div>客队：${fixture.away_team}</div>
                    <div>时间：${fixture.time}</div>
                `;

                boundItem.appendChild(networkDiv);
            });

            // 添加删除功能
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn'; // 使用新定义的样式类
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteBtn.onclick = () => boundItem.remove();
            boundItem.appendChild(deleteBtn);

            document.getElementById('bound-matches-container').prepend(boundItem);

            // 清除选中状态
            Object.keys(selectedFixtures).forEach(source => {
                selectedFixtures[source] = null;
                const table = dataSourcesData[source].table;
                table.querySelectorAll('tr').forEach(tr => tr.classList.remove('selected-row'));
            });
            document.getElementById('add-binding-btn').disabled = true;
        });

        // 初始化搜索框监听
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input[data-source]').forEach(input => {
                const source = input.dataset.source;
                input.addEventListener('input', debounce((e) => {
                    filterFixtures(source, e.target.value);
                }, 300)); // 300ms防抖延迟
            });
        });

// 提交按钮点击事件
document.querySelector('button.custom-btn[style="color: green;"]').addEventListener('click', async () => {
    const boundItems = document.querySelectorAll('.bound-item');
    const requests = [];

    boundItems.forEach(item => {
        const request = { 
            source1: parseSourceData(item, 0),
            source2: parseSourceData(item, 1),
            source3: parseSourceData(item, 2)
        };
        requests.push(request);
    });

    try {
        const response = await fetch('http://localhost:8080/api/bindings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requests),
        });

        if (!response.ok) {
            throw new Error(`提交失败: ${response.statusText}`);
        }
        alert('提交成功！');
    } catch (error) {
        console.error('提交错误:', error);
        alert(`提交失败: ${error.message}`);
    }
});

// 解析DOM数据的方法
function parseSourceData(item, index) {
    const sourceDiv = item.querySelectorAll('.network-data')[index];
  
    
    return {
        leagueName: sourceDiv.children[1].textContent.split('：')[1],
        homeTeam: sourceDiv.children[2].textContent.split('：')[1],
        awayTeam: sourceDiv.children[3].textContent.split('：')[1],
         
        source: index + 1
    };
}

 
    </script>
</body>

</html>